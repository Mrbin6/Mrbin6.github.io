<!--使用说明：
    核心3个div:bj_left_ul、holder_div、bj_input  前两个div不能删除，bj_input可以删除，删除之后要注释一小部分会去查找这个div的代码。
    可以将bj_left_ul 和holder_div嵌入到网页的任何地方，但是要注意有可能会出现css样式冲突。
    可以任意改变bj_left_ul的样式。
    在修改holder_div的样式的时候要注意：
        holder_div的样式可以任意改。
        其后代3个子孙元素的高度必须相同。
        其中覆盖层cover_div（z-index:100或300）和显示层bj_right_ul（z-index:200）的宽高必须相同。
        scroll_div层用于拿到y轴滚动的距离。
        不能给后代3个子孙元素加padding或者是margin，如果一定要加，要小心。
-->

<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>拖动div</title>
    <script src="jquery-1.11.3.js"></script>
    <script src="jquery-ui.js"></script>
</head>
<style>
    * {
        padding: 0;
        margin: 0;
        list-style: none;
    }

    .bj_right_ul li {
        display: block;
        list-style-type: none;
        box-sizing: border-box;
        -moz-box-sizing: border-box; /* Firefox */
        -webkit-box-sizing: border-box; /* Safari */
        cursor: pointer;
        border: 1px solid transparent;
        overflow:hidden;
    }

    .bj_right_ul li.hover {
        border: 1px solid lightblue;
    }

    .bj_right_ul li.redborder {
        border: 1px solid red;
    }

    .bj_left_ul li {
        height: 60px;
        width: 120px;
        border: 4px solid #095df7;
        margin: 20px auto 0 auto;
        font: bold 16px/60px "微软雅黑";
        color: #150491;
        text-align: center;
    }

    .bj_bigdiv {
        height: 529px;
        width: 1200px;
        border: 1px solid black;
        margin: 0 auto;
    }

    .bj_left_ul {
        float: left;
    }

    .bj_input {
        float: left;
        margin-top: 50px;
        margin-left: 10px;
        display: none;
    }

    .bj_input textarea {
        resize: none;
        height: 150px;
        width: 200px;
    }

    .dashed_div1 {
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
        border: 1px dashed #222;
        margin:0 auto;
        /*height:30px;*/
        /*width:300px;*/
    }
    /*.bj_right_ul>.dashed_div2 {*/
        /*-webkit-box-sizing: border-box;*/
        /*-moz-box-sizing: border-box;*/
        /*box-sizing: border-box;*/
        /*border: 1px dashed #222;*/
        /*height:60px;*/
        /*width:300px;*/
    /*}*/
    /*.bj_right_ul>.dashed_div3 {*/
        /*-webkit-box-sizing: border-box;*/
        /*-moz-box-sizing: border-box;*/
        /*box-sizing: border-box;*/
        /*border: 1px dashed #222;*/
        /*height:80px;*/
        /*width:300px;*/
    /*}*/

    .btn_comfirm {
        height: 40px;
        width: 120px;
        background-color: blue;
        border-radius: 5px;
        line-height: 30px;
        text-align: center;
        font-size: 16px;
        color: white;
        font-weight: bold;
    }

    .out_div {
        margin-top: 20px;
        height: 400px;
        width: 300px;
        border: 1px solid black;
    }

    .cover_div {
        position: absolute;
        left: 0;
        top: 0;
        z-index: 200;
    }

    .holder_div {
        position: relative;
        float: left;
        margin-left: 50px;
        overflow: hidden;
    }

    .bj_right_ul {
        position: relative;
        z-index: 200;
        padding: 0 0 50px 0;
        margin: 0;
        border: 1px solid lightblue;
        background-color: #eef;
    }

    .scroll_div {
        overflow-y: auto;
        position:relative;/*给ie加的，父元素不给力还是不行*/
        z-index:200;/*给ie加的，父元素还是要给力才行*/
    }
    .bj_assemble{
        display:none;
    }

</style>
<body>
<div class="bj_bigdiv">
    <!--源ul,拖拽的东西都放在这里面-->
    <ul class="bj_left_ul">
        <li id="input_type" draggable="true">我是输入框部件</li>
        <li id="image_type" draggable="true">我是图片部件</li>
    </ul>
    <!--目标div,hold_div用于整体定位-->
    <div class="holder_div">
        <div class="cover_div"></div>
        <div class="scroll_div">
            <ul class="bj_right_ul"></ul>
        </div>
    </div>
    <!--用于修改目标ul（bj_righ_ul）中的li的innerHTML的文本框-->
    <div class="bj_input">
        <textarea id="input_area" value="这里可以输入文字"></textarea><br/>
        <button id="confirm">确 认</button>
    </div>
    <ul class="bj_assemble" data-bind="" >
        <li><img src="chrome.png"/></li>
        <li><button>按钮</button></li>
    </ul>
</div>
<br/>
<button class="btn_comfirm" id="conf">确认生成对象</button>
<button class="btn_comfirm" id="output">生成网页</button>
<div class="out_div">
    <ul id="out_ul">
    </ul>
</div>
</body>
<script>
    //注意：不要随便给li加padding，margin什么的。
    $(function () {
        var LEFTDIVWIDTH = 300;
        var LEFTDIVHEIGHT = 500;//定义左边的ul的宽高，以便嵌入其他元素时好改动
        var RIGHTDIVWIDTH = 90;//定义右边的ul的宽高，这个是百分比！！
        var RIGHTDIVHEIGHT = 100;//定义右边的ul的宽高，这个是百分比！！
        var SCROLLDIVWIDTH = 100;//这个是百分比！！
        var SCROLLDIVHEIGHT = 100;//定义滚动框，也就是目标ul的父级div的宽高,这个是百分比！！
        var HOLDERDIVWIDTH = 400;
        var HOLDERDIVHEIGHT = 500;//定义定位层holder_div的宽高
//        var RIGHTLIHEIGHT = 60;
//        var RIGHTLIWIDTH = 100;//生成的li的宽高
        var DASHEDDIVHEIGHT = 70;//虚线框的高度，随意定吧，哈哈哈哈。
        var DASHEDDIVWIDTH = 100;//虚线框的宽度,这个是百分比！！
        var ADDEDLIMINHEIGHT = 50;//添加的li的最小高度像素
        var ADDEDLIMINWIDTH = 100;//添加的li的最小宽度这个是百分比！！

        $(".holder_div").css({"height": HOLDERDIVHEIGHT, "width": HOLDERDIVWIDTH});
        $(".bj_left_ul").css({"height": LEFTDIVHEIGHT, "width": LEFTDIVWIDTH});//左边ul宽高赋值
        $(".scroll_div").css({"height": SCROLLDIVHEIGHT+"%", "width": SCROLLDIVWIDTH+"%"});//右边ul宽高赋值
        $(".bj_right_ul").css({"min-height": RIGHTDIVHEIGHT+"%", "width": RIGHTDIVWIDTH+"%"});//右边ul宽高赋值
        $(".cover_div").css({"height": SCROLLDIVHEIGHT+"%", "width": RIGHTDIVWIDTH+"%"});//右边ul的cover层的宽高赋值，高度为scroll层的高度！！
        //$(".bj_right_ul>li").css({"height": RIGHTLIHEIGHT, "width": RIGHTLIWIDTH});//右边ul中的li的宽高

        // $(".holder_div").css({ "height": HOLDERDIVHEIGHT,"width": HOLDERDIVWIDTH});//右边定位层holder_div的宽高赋值
        var options = [];//维护右边ul结构的对象数组，形如 [{startY:30,endY:60,height:20},{...},{...}];
        //!!!!!options数组对象中的对象的顺序从始至终都没有改变过，因为就算目标ul中的li的顺序改变了，li的数量是绝对不会改变的。
        //不用维护options这个数组的顺序，哈哈。
        var data_type;//由于在dragover事件中拿不到dataTransfer中的数据，干脆全部用全局变量代替了。！！！
        //源对象
        $(".bj_left_ul>li").on("dragstart", function (event) {
            event.originalEvent.dataTransfer.setData("Text", "");//firefox卖萌吧，不加这行语句就没效果。
            data_type = event.target.id;
            $(".cover_div").css({"z-index": 300});//注意，这里z-index是300
            if(options.length!=0){//必须要从新从页面读取高度，从新赋值区间
                var lis=$(".bj_right_ul>li");
                options[0].height=parseInt($(lis[0]).css("height").slice(0,-2));
                options[0].startY=0;
                options[0].endY=options[0].height;
                for(var i= 1,k=lis.length;i<k;i++){
                    options[i].height=parseInt($(lis[i]).css("height").slice(0,-2));
                    options[i].startY = options[i - 1].endY + 1;
                    options[i].endY = options[i].startY + options[i].height - 1;
                }
            }
        });
        var idNum = 1;//关联li与改变li内容的框。


        var isChosen=false;//用于判断是否选中了li
        var iNum=[];//临时保存一个i的值
            iNum[1]=-1;//第一个iNum[1]的值，千万不要轻易更改。
        var heightNum=[];//用于保存3个高度值
        //目标对象
        var _coverDiv = $(".cover_div");
        _coverDiv.on("dragover", function (event) {
            event.preventDefault();
            event.stopPropagation();
            var data = data_type;
            $("#dashed_div").parent().remove();
                var $item = $(document.createElement("li"));
                var html = "";
                if (data == "input_type") {
                    html = "<div id='dashed_div' class='dashed_div1'></div>";
                }
                else if (data == "image_type") {
                    html = "<div id='dashed_div' class='dashed_div1'></div>";
                }
                $item.html(html);//虚线框节点赋值完毕
                //获取鼠标相对于目标ul左上角的坐标
                var pageY=event.originalEvent.pageY||event.originalEvent.y;
                var y = pageY - _coverDiv.offset().top;//鼠标相对于容器的y坐标
                y += $(".scroll_div").scrollTop();//加上滚动偏移y，否则滚动之后就完蛋了

                var _destUl = $(".bj_right_ul");
                var k = options.length;//option对象数组的长度，放在外边，防止长度改变之后影响其他部分
                isChosen=false;

                if (options.length == 0) {
                    _destUl.append($item);
                } else {
                    var lis=$(".bj_right_ul>li");
                    for (var i = 0; i < k; i++) {
                        if (y >= options[i].startY && y <= options[i].endY) {//放在了ul中的li上
                                        if(i!=iNum[0]) {//控制只进入同一li只进入一次
                                            heightNum[3] = options[i].height;
                                            options[i].height += DASHEDDIVHEIGHT;//这里是虚线框高度的关键点
                                            if(i!=0 && iNum[0]!=i-1) {//还没交换
                                                options[i].startY = options[i - 1].endY+1;

                                            }else if(i!=0 && iNum[0]==i-1){
                                                options[i].startY=options[iNum[0]].startY +heightNum[0];//往下移的时候，本li的起点变了
                                            }else if(i==0){
                                                options[i].startY=0;
                                            }
                                            options[i].endY = options[i].startY + options[i].height - 1;
                                                if(iNum[1]!=-1) {//这个if也不能去掉，否者会出现0-（-1）的情况，你说是不是变成NAN?
                                                    iNum[0] += iNum[1];
                                                    iNum[1] = iNum[0] - iNum[1];
                                                    iNum[0] -= iNum[1];

                                                    heightNum[0] += heightNum[1];
                                                    heightNum[1] = heightNum[0] - heightNum[1];
                                                    heightNum[0] -= heightNum[1];
                                                }
                                                iNum[0] = i;
                                                heightNum[0]=heightNum[3];
                                                if(iNum[1]==-1){//不能用if(iNum[1]) !! 因为有iNum[1]的值为0的情况。
                                                    iNum[1]=iNum[0];
                                                    heightNum[1]=heightNum[0];
                                                }else{
                                                    options[iNum[1]].height=heightNum[1];
                                                    if(iNum[1]!=0){
                                                      options[iNum[1]].startY=options[iNum[1]-1].endY+1;
                                                    }else{
                                                        options[iNum[1]].startY=0;
                                                    }
                                                    options[iNum[1]].endY=options[iNum[1]].startY+options[iNum[1]].height-1;
                                                }
                                                for (var j = iNum[0] + 1, len = options.length; j < len; j++) {//将下面的位置重置
                                                    options[j].startY = options[j - 1].endY + 1;
                                                    options[j].endY = options[j].startY + options[j].height - 1;//卧槽，陷阱啊，1+36就是37了，如果这里加37，那么每次都多1！！！！
                                                }
                                        }
                                $("#dashed_div").parent().remove();
                                _destUl.find("li:nth-child(" + (i + 1) + ")").before($item);
                            isChosen=true;
                            break;//已经添加过了LI了就break.
                        }
                    }
                    if (isChosen==false) {//所有的li都检查过了且不满足，放在了ul中的其他地方
                        _destUl.append($item);
                        var len=options.length;
                        options[len-1].height=parseInt($(".bj_right_ul> li:eq("+(len-1)+")").css("height").slice(0,-2));
                        if(len-2>=0) {
                            options[len - 1].startY = options[len - 2].endY + 1;
                        }else{
                            options[len-1].startY=0;
                        }
                        options[len-1].endY=options[len-1].startY+options[len-1].height-1;
                        heightNum[1]=options[len-1].height;
                        iNum[0]=-1;
                        iNum[1]=len-1;
                    }
                }
            $(".dashed_div1").parent("li").css({"height": DASHEDDIVHEIGHT, "width": DASHEDDIVWIDTH+"%"});//虚线框li的宽高，必须在虚线框生成之后赋值
            $(".dashed_div1").css({"height": DASHEDDIVHEIGHT-2, "width": DASHEDDIVWIDTH-1+"%"});//虚线框宽高

        });
        $(".bj_left_ul>li").on("dragend", function (event) {
            event.preventDefault();
            event.stopPropagation();
            $(".cover_div").css({"z-index": 100});//要将z-index改为100
            iNum[0]=-1;//非常重要赋值,解决一个bug
        });
        _coverDiv.on("dragleave", function (event) {
            event.preventDefault();
            event.stopPropagation();
            $("#dashed_div").parent().remove();
            //$(".cover_div").css({"z-index": 100});//要将z-index改为100
            if(options.length!=0){//必须要从新从页面读取高度，从新赋值区间
                var lis=$(".bj_right_ul>li");
                options[0].height=parseInt($(lis[0]).css("height").slice(0,-2));
                options[0].startY=0;
                options[0].endY=options[0].height;
                for(var i= 1,k=lis.length;i<k;i++){
                    options[i].height=parseInt($(lis[i]).css("height").slice(0,-2));
                    options[i].startY = options[i - 1].endY + 1;
                    options[i].endY = options[i].startY + options[i].height - 1;
                }
            }
            iNum[0]=-1;//重新赋值
        });
        _coverDiv.on("drop", function (event) {
            event.preventDefault();
            event.stopPropagation();
            var data = data_type;
            //生成将要保存的li节点的信息对象
            var objLi = {
                startY: 0,
                endY: 0,
                height: 0,
                width:0
            };
            idNum++;
            var $item = $(document.createElement("li"));
            $item.attr("id", "li" + idNum);

            $(".bj_input").show();
            $(".bj_assemble").show();
            $(".bj_input>textarea").attr("name", $item.attr("id")).val("这里输入的内容会更新到左边的框里。");//在生成li的时候要直接修改textarea的name一次。
            $(".bj_assemble").attr("data-bind",$item.attr("id"));
            $item.click(function () {//必须在生成li的时候加，否则事件触发不了
                $(".bj_input>textarea").attr("name", $item.attr("id"));
                $(".bj_assemble").attr("data-bind",$item.attr("id"));
            });
            $(".bj_right_ul>li").removeClass("redborder");//放下时显示红框
            $item.addClass("redborder");

            var html = "";
            if (data == "input_type") {
                html = "<input id='d1' class='bj_change_value' type='text' value='输入文本'/>";
                $item.attr("data-type", "input_type");
                $item.attr("data-height", 30 + "px");
//                $item.min-height=30;
               objLi.height=ADDEDLIMINHEIGHT;//可以自定义
                objLi.width=ADDEDLIMINWIDTH;//右边ul中的li的宽高;
            }
            else if (data == "image_type") {
                html = "<img src='chrome.png'/>";
                $item.attr("data-type", "image_type");
                $item.attr("data-height", 60 + "px");
               objLi.height=ADDEDLIMINHEIGHT;//可以自定义
                objLi.width=ADDEDLIMINWIDTH;//右边ul中的li的宽高;
            }
             //定下新生节点的默认值
            objLi.endY = objLi.height;//默认startY是0，endY是高度。
            if (options.length > 0) {//如果维护的数组大于0，要插入的li的起始位置为上一个li的结束位置加1,否则就是0。
                objLi.startY = options[options.length - 1].endY + 1;//必须要大1
                objLi.endY = objLi.startY + objLi.height - 1;//必须要减1否则就大了1了！
            }
            $item.html(html);//新li节点赋值完毕
            //获取鼠标相对于目标ul左上角的坐标
            var pageY=event.originalEvent.pageY||event.originalEvent.y;
            var y = pageY - _coverDiv.offset().top;//鼠标相对于容器的y坐标
            y += $(".scroll_div").scrollTop();//加上滚动偏移y，否则滚动之后就完蛋了

            var _destUl = $(".bj_right_ul");
            var k = options.length;//option对象数组的长度，放在外边，防止长度改变之后影响其他部分
            if (options.length == 0) {
                options.push(objLi);
                _destUl.append($item);
            } else {
                var isChosen=false;//用于判断是否选中了li
                var iNum=1;//用于临时保存一个i值
                for (var i = 0; i < k; i++) {
                    if (y >= options[i].startY && y <= options[i].endY) {//放在了ul中的li上
                        if (y <= options[i].endY) {//放在上半部分
                            objLi.startY = options[i].startY;
                            objLi.endY = objLi.startY + objLi.height - 1;//只能在定了插入位置之后给当前要插入的li，赋值开始结束位置。
                            options.splice(i, 0, objLi);//在当前li前面插入。
                            _destUl.find("li:nth-child(" + (i + 1) + ")").before($item);
                        }
                        iNum=i;
                        isChosen=true;//修改标记
                        break;//已经添加过了LI了就break.
                    }
                }
                if (isChosen==false) {//所有的li都检查过了，一个都没选中放在了ul中的其他地方
                    options.push(objLi);
                    _destUl.append($item);
                }else{//已经作了修改了。
                    //维护对象数组得在插入之后，只需要维护基本的坐标就行了，信息没必要维护
                    for (var j = iNum + 1, len = options.length; j < len; j++) {//将下面的位置重置
                        options[j].startY = options[j - 1].endY + 1;
                        options[j].endY = options[j].startY + options[j].height - 1;//卧槽，陷阱啊，1+36就是37了，如果这里加37，那么每次都多1！！！！
                    }
                }
            }
            $("#dashed_div").parent().remove();//添加了节点之后要删除虚线框
            $(".cover_div").css({"z-index": 100});//要将z-index改为100
            $("#li"+idNum).css({"min-height":ADDEDLIMINHEIGHT,"width":objLi.width+"%"});
            $(".bj_right_ul>li")//右边ul的cover层的宽高赋值,必须要在插入li之后赋值
                    .on("mouseover", function () {
                        $(this).addClass("hover");
                    })
                    .on("mouseout", function () {
                        $(this).removeClass("hover");
                    });
        });
        var _dest = $(".bj_right_ul");
        _dest.sortable();//JQUERY UI sortable组件
    });
    $(function () {
        $(":not(.bj_right_ul)").on("drop", function (event) {//取消其它框（除了.bj_right_ul框）拖入东西的默认效果。
            event.preventDefault();
            event.stopPropagation();
        });
        $("#confirm").click(function () {//点击确定，将textarea中的文本放到对应的li中。
            var text = $("#input_area").val();
            if (text) {
                var liId = $("#input_area").attr("name");
                if (liId) {
                    $("#" + liId).html(text);
                    $("#" + liId).attr("data-change", "changed");
                }
            }
        });
        $(document).click(function (event) {//点击
            if (event.target.id.slice(0, 2) == "li") {
                $(".bj_input").show();
                $(".bj_assemble").show();
                //控制红框
                $(".bj_right_ul>li").removeClass("redborder");
                $(event.target).addClass("redborder");
            } else if (event.target.id == "input_area" || event.target.id == "confirm"
                    ||event.target.className==".bj_assemble"||$(event.target).parents(".bj_assemble").length==1) {
                //这里是点击了右部编辑框的输入框或者是按钮，什么也不干。
            } else {
                $(".bj_right_ul>li").removeClass("redborder");
                $(".bj_input").hide();
                $(".bj_assemble").hide();
            }
        });

        //生成一个用于生成网页的对象,对象的样子是[{type:"data-type",text:"",isChange:true}]
        var product = [];
        $("#conf").click(function () {
            var lis = $(".bj_right_ul>li");
            for (var i = 0; i < lis.length; i++) {
                var oneLi = {};
                oneLi.type = lis[i].getAttribute("data-type");
                if (lis[i].getAttribute("data-change") == "changed") {
                    oneLi.text = $(lis[i]).html();
                    oneLi.isChange = true;
                }
                product.push(oneLi);
            }
        });
        //生成网页
        //根据对象poduct[i]中的数据生成网页。
        $("#output").click(function () {
            var _lis = $("#out_ul");
            var htmlText = "";
            for (var i = 0; i < product.length; i++) {
                if (product[i].type == "input_type") {
                    if (product[i].isChange && product[i].isChange == true) {
                        htmlText += "<li>" + product[i].text + "</li>";
                    } else {
                        htmlText += "<li><input class='bj_change_value' type='text' value='输入文本'/></li>"
                    }
                }
                if (product[i].type == "image_type") {
                    if (product[i].isChange && product[i].isChange == true) {
                        htmlText += "<li>" + product[i].text + "</li>";
                    } else {
                        htmlText += "<li><img src='chrome.png'/></li>"
                    }
                }
            }
            _lis.html(htmlText);
            product.length = 0;
        });

        $(".bj_assemble").click(function(event){
            if(event.target.nodeName=="LI") {
                var html = event.target.innerHTML;
            }else if($(event.target).parents("li").length==1){
                var html = $(event.target).parents("li").html();
            }
            var liId = $(this).attr("data-bind");
            if (liId) {
                $("#" + liId).append(html);
                $("#" + liId).attr("data-change", "changed");
            }
        });
    });
</script>
</html>
