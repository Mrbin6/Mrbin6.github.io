<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>拖动div的特效1</title>
    <script src="jquery-1.11.3.js"></script>
    <script src="jquery-ui.js"></script>
</head>
<style>
    li {
        display: block;
        list-style-type: none;
        width: 270px;
        height: 30px;
        border: 1px solid black;
        padding-top: 5px;
    }

    .bj_bigdiv {
        height: 529px;
        width: 1200px;
        border: 1px solid black;
    }

    .bj_left_ul{
        float: left;
        border: 1px solid black;
    }

    .bj_input {
        float: left;
        margin-top: 50px;
        margin-left: 10px;
        display: none;
    }

    .bj_input > textarea {
        resize: none;
        height: 150px;
        width: 200px;
    }

    .dashed_div1 {
        border: 1px dashed #222;
    }

    .dashed_div2 {
        height: 50px;
        width: 270px;
        border: 1px dashed green;
    }

    .dashed_div3 {
        height: 0px;
        width: 270px;
        border: 1px dashed green;
    }

    .btn_comfirm {
        height: 40px;
        width: 120px;
        background-color: blue;
        border-radius: 5px;
        line-height: 30px;
        text-align: center;
        font-size: 16px;
        color: white;
        font-weight: bold;
    }

    .out_div {
        margin-top: 20px;
        height: 600px;
        width: 400px;
        border: 1px solid black;
    }
    .cover_div{
        position:absolute;
        left:0;
        top:0;
        z-index:200;
        border:1px solid black;
    }
    .holder_div{
        position:relative;
        float:left;
        margin-left:50px;
        overflow:hidden;
    }
    .bj_right_ul{
        position:relative;
        z-index:200;
        border:1px solid green;
        padding:0 0 50px 0;
        margin:0;
        box-sizing:border-box;
    }
    .scroll_div{
        overflow-y:auto;
        border:1px solid red;
    }
</style>
<body>
<div class="bj_bigdiv">
    <ul class="bj_left_ul">
        <li id="input_type" draggable="true">我是输入框部件</li>
        <li id="image_type" draggable="true">我是图片部件</li>
    </ul>
    <div class="holder_div">
        <div class="cover_div"></div>
        <div class="scroll_div">
            <ul class="bj_right_ul" ></ul>
        </div>
    </div>
    <div class="bj_input">
        <textarea id="input_area" value="这里可以输入文字"></textarea><br/>
        <button id="confirm">确 认</button>
    </div>
</div>
<br/>
<button class="btn_comfirm" id="conf">确认生成对象</button>
<button class="btn_comfirm" id="output">生成网页</button>

<div class="out_div">
    <ul id="out_ul">

    </ul>
</div>
</body>
<script>

    $(function () {
        var LEFTDIVWIDTH = 300;
        var LEFTDIVHEIGHT = 500;//定义左边的ul的宽高，以便嵌入其他元素时好改动
        var RIGHTDIVWIDTH = 300;
        var RIGHTDIVHEIGHT = 300;//定义右边的ul的宽高，以便嵌入其他元素时好改动
        var SCROLLDIVWIDTH = 400;
        var SCROLLDIVHEIGHT = 500;//定义滚动框，也就是目标ul的父级div的宽高
        var DASHEDDIVWIDTH = 270;
        var DASHEDDIVHEIGHT = 30;//定义虚线框的宽高
        var HOLDERDIVWIDTH = 402;
        var HOLDERDIVHEIGHT = 502;//定义定位层holder_div的宽高
        $(".bj_left_ul").css({"height": LEFTDIVHEIGHT, "width": LEFTDIVWIDTH});//左边ul宽高赋值
        $(".scroll_div").css({ "height": SCROLLDIVHEIGHT,"width": SCROLLDIVWIDTH});//右边ul宽高赋值
        $(".dashed_div1").css({"height":DASHEDDIVHEIGHT,"width":DASHEDDIVWIDTH});//虚线框宽高
        $(".bj_right_ul").css({ "min-height": RIGHTDIVHEIGHT,"width": RIGHTDIVWIDTH});//右边ul宽高赋值
        $(".cover_div").css({ "height": RIGHTDIVHEIGHT,"width": RIGHTDIVWIDTH});//右边ul的cover层的宽高赋值
       // $(".holder_div").css({ "height": HOLDERDIVHEIGHT,"width": HOLDERDIVWIDTH});//右边ul的cover层的宽高赋值
        var options = [];//维护右边ul结构的对象数组，形如 [{type:"input_type",height:20,width:270,isChange:true,text:"abcd"},{...},{...}];
        var data_type;//由于在dragover事件中拿不到dataTransfer中的数据，只能用全局变量代替了。！！！
        //源对象
        $(".bj_left_ul>li").on("dragstart", function (event) {
            //event.originalEvent.dataTransfer.setData("Text", event.target.id);
            data_type=event.target.id;
            coverHeightChange(300)//注意，这里z-index是300
        });
        var idNum = 1;//关联li与改变li内容的框。

        function coverHeightChange(zIndex){//在dragstart,dragover,dragend 的恰当位置让over层的大小和目标ul一致
            if(zIndex) {//如果传参数了
                var ulHeight = $(".bj_right_ul").css("height");
                $(".cover_div").css({"z-index": zIndex, "height": ulHeight});//将遮罩层的高度改为目标ul的高度
            }else{
                var ulHeight = $(".bj_right_ul").css("height");
                $(".cover_div").css({"height": ulHeight});//将遮罩层的高度改为目标ul的高度
            }
        }
        $(".bj_left_ul>li").on("dragend", function (event) {
            coverHeightChange(100);
        });
        var _dest = $(".bj_right_ul");
        //目标对象
        var _coverDiv = $(".cover_div");
        _coverDiv.on("dragover", function (event) {
            event.preventDefault();
            event.stopPropagation();
            var data=data_type;
            $("#dashed_div").parent().remove();
            if (data == "") {
                return false;
            }
            else {
                var $item = $(document.createElement("li"));
                var html = "";
                if (data == "input_type") {
                    html = "<div id='dashed_div' class='dashed_div1'>我是输入框</div>";
                }
                else if (data == "image_type") {
                    html = "<div id='dashed_div' class='dashed_div1'>我是图片框</div>";
                }
                $item.html(html);//虚线框节点赋值完毕
                //获取鼠标相对于目标ul左上角的坐标
                var x = event.originalEvent.pageX - _coverDiv.offset().left;//鼠标相对于容器的x坐标
                var y = event.originalEvent.pageY - _coverDiv.offset().top;//鼠标相对于容器的y坐标
                x+=$(".scroll_div").scrollLeft();//加上滚动偏移x，否则滚动之后就完蛋了
                y+=$(".scroll_div").scrollTop();//加上滚动偏移y，否则滚动之后就完蛋了

                var _destUl = $(".bj_right_ul");
                var k=options.length;//option对象数组的长度，放在外边，防止长度改变之后影响其他部分
                if (options.length == 0) {
                    _destUl.append($item);
                } else {
                    for(var i = 0;i<k;i++){
                        if(y>=options[i].startY && y<=options[i].endY){//放在了ul中的li上
                            if(y>(options[i].endY)){//如果放在了下半部分,超出li的高，为下半部分
                                $("#dashed_div").parent().remove();
                                _destUl.find("li:nth-child("+(i+1)+")").after($item);
                            }else{//放在上半部分
                                $("#dashed_div").parent().remove();
                                _destUl.find("li:nth-child("+(i+1)+")").before($item);
                            }
                            break;//已经添加过了LI了就break.
                        }
                    }
                    if(i==k){//i==k时，所有的li都检查过了且不满足，放在了ul中的其他地方
                        _destUl.append($item);
                    }
                }
            }
            coverHeightChange();
        });
        _coverDiv.on("dragleave", function (event) {
            event.preventDefault();
            event.stopPropagation();
            $("#dashed_div").parent().remove();
            coverHeightChange();
        });

        _coverDiv.on("drop", function (event) {
            event.preventDefault();
            event.stopPropagation();
//            $("#dashed_div").parent().remove();
//            var df = event.originalEvent.dataTransfer;
//            var data = df.getData("Text");
            var data = data_type=event.target.id;;
            //生成将要保存的li节点的信息对象
            var objLi = {
                startY: 0,
                endY: 0,
                height: 37
            };
            //定下新生节点的默认值
            objLi.endY=objLi.height;//默认startY是0，endY是高度。
            if(options.length>0) {//如果维护的数组大于0，要插入的li的起始位置为上一个li的结束位置加1,否则就是0。
                objLi.startY =options[options.length - 1].endY+1;//必须要大1
                objLi.endY=objLi.startY+objLi.height-1;//必须要减1否则就大了1了！
            }

            if (data == "") {
                return false;
            }
            else {
                idNum++;
                var $item = $(document.createElement("li"));
                $item.attr("id", "li" + idNum);
                $item.attr("data-type");//用于判断是什么类型的节点
                $item.attr("data-change");//用于判断li里面的内容是否改变。

 					$(".bj_input").show();
 					$(".bj_input>textarea").attr("name",$item.attr("id")).val("这里输入的内容会更新到左边的框里。");//在生成li的时候要直接修改textarea的name一次。
 					$item.click(function(){//必须在生成li的时候加，否则事件触发不了
 						$(".bj_input>textarea").attr("name",$item.attr("id"));
 					});
                var html = "";
                if (data == "input_type") {
                    html = "<input id='d1' class='bj_change_value' type='text' value='输入文本'/>";
                    $item.attr("data-type", "input_type");
                    $item.attr("data-height","37px");
                }
                else if (data == "image_type") {
                    html = "<img src='chrome.png'/>";
                    $item.attr("data-type", "image_type");
                    $item.attr("data-height","37px");
                }
                $item.html(html);//新li节点赋值完毕
                //获取鼠标相对于目标ul左上角的坐标
                var x = event.originalEvent.pageX - _coverDiv.offset().left;//鼠标相对于容器的x坐标
                var y = event.originalEvent.pageY - _coverDiv.offset().top;//鼠标相对于容器的y坐标
                x+=$(".scroll_div").scrollLeft();//加上滚动偏移x，否则滚动之后就完蛋了
                y+=$(".scroll_div").scrollTop();//加上滚动偏移y，否则滚动之后就完蛋了

                var _destUl = $(".bj_right_ul");
                var k=options.length;//option对象数组的长度，放在外边，防止长度改变之后影响其他部分
                if (options.length == 0) {
                    options.push(objLi);
                    _destUl.append($item);
                } else {
                    for(var i = 0;i<k;i++){
                        if(y>=options[i].startY && y<=options[i].endY){//放在了ul中的li上
                            if(y>=(options[i].startY+options[i].height)){//如果放在了下半部分，超出li的高，为下半部分
                                objLi.startY=options[i].endY+1;
                                objLi.endY=objLi.startY+objLi.height-1;//只能在定了插入位置之后给当前要插入的li，赋值开始结束位置。
                                options.splice(i+1,0,objLi);//在当前li后面插入。
                                _destUl.find("li:nth-child("+(i+1)+")").after($item);
                                //维护对象数组得在插入之后，只需要维护基本的坐标就行了，信息没必要维护
                                for(var j=i+1,len=options.length;j<len;j++){//将下面的位置重置
                                    options[j].startY=options[j-1].endY+1;
                                    options[j].endY=options[j].startY+options[j].height-1;
                                }
                            }else{//放在上半部分
                                objLi.startY=options[i].startY;
                                objLi.endY=objLi.startY+objLi.height-1;//只能在定了插入位置之后给当前要插入的li，赋值开始结束位置。
                                options.splice(i,0,objLi);//在当前li前面插入。
                                _destUl.find("li:nth-child("+(i+1)+")").before($item);
                                //维护对象数组得在插入之后，只需要维护基本的坐标就行了，信息没必要维护
                                for(var j=i+1,len=options.length;j<len;j++){//将下面的位置重置
                                    options[j].startY=options[j-1].endY+1;
                                    options[j].endY=options[j].startY+options[j].height-1;//卧槽，陷阱啊，1+36就是37了，如果这里加37，那么每次都多1！！！！
                                }
                            }
                            break;//已经添加过了LI了就break.
                        }
                    }
                    if(i==options.length){//options的长度没变化，所有的li都检查过了，放在了ul中的其他地方
                        options.push(objLi);
                        _destUl.append($item);
                    }
                }
            }
        });
        _dest.sortable();//JQUERY UI sortable组件

    $(function(){
     		$("#input_area").on("drop",function(event){//取消textarea框拖入东西的默认效果。
     			event.preventDefault();
     			event.stopPropagation();
     		});
     		$("#confirm").click(function(){//点击确定，将textarea中的文本放到对应的li中。
     			var text=$("#input_area").val();
     			if(text){
     				var liId=$("#input_area").attr("name");
     				if(liId){
     					$("#"+liId).html(text);
     					$("#"+liId).attr("data-change","changed");
     				}
     			}
     		});
     		$(document).click(function(event){//点击
     			if(event.target.id.slice(0,2)=="li"){
     				$(".bj_input").show();
     			}else if(event.target.id=="input_area"||event.target.id=="confirm"){
     				//这里是点击了右部编辑框的输入框或者是按钮，什么也不干。
     			}else{
     				$(".bj_input").hide();
     			}
     		});

     		//生成一个用于生成网页的对象,对象的样子是[{type:"data-type",text:"",isChange:true}]
     		var product=[];
     		$("#conf").click(function(){
     			var lis=$(".bj_right_ul>li");
     			for(var i=0;i<lis.length;i++){
     				var oneLi={};
     				oneLi.type=lis[i].getAttribute("data-type");
     				if(lis[i].getAttribute("data-change")=="changed"){
     					oneLi.text=$(lis[i]).html();
     					oneLi.isChange=true;
     				}
     				product.push(oneLi);
     			}
     		});
     		//生成网页
     		//根据对象poduct[i]中的数据生成网页。
     		$("#output").click(function(){
     			var _lis=$("#out_ul");
     			var htmlText="";
     			for(var i=0;i<product.length;i++){
     				if(product[i].type=="input_type"){
     					if(product[i].isChange && product[i].isChange==true){
     						htmlText+="<li>"+product[i].text+"</li>";
     					}else{
     						htmlText+="<li><input class='bj_change_value' type='text' value='输入文本'/></li>"
     					}
     				}
     				if(product[i].type=="image_type"){
     					if(product[i].isChange && product[i].isChange==true){
     						htmlText+="<li>"+product[i].text+"</li>";
     					}else{
     						htmlText+="<li><img src='chrome.png'/></li>"
     					}
     				}
     			}
     			_lis.html(htmlText);
     			product.length=0;
     		});
     	});
    });
</script>
</html>
