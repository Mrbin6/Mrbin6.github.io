<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>拖动div的特效1</title>
    <script src="jquery-1.11.3.js"></script>
    <script src="jquery-ui.js"></script>
</head>
<style>
    * {
        padding: 0;
        margin: 0;
        list-style: none;
    }

    .bj_right_ul > li {
        display: block;
        list-style-type: none;
        box-sizing: border-box;
        -moz-box-sizing: border-box; /* Firefox */
        -webkit-box-sizing: border-box; /* Safari */
        cursor: pointer;
        border: 1px solid transparent;
    }

    .bj_right_ul > li.hover {
        border: 1px solid lightblue;
    }

    .bj_right_ul > li.redborder {
        border: 1px solid red;
    }

    .bj_left_ul > li {
        height: 60px;
        width: 120px;
        border: 4px solid #095df7;
        margin: 20px auto 0 auto;
        font: bold 16px/60px "微软雅黑";
        color: #150491;
        text-align: center;
    }

    .bj_bigdiv {
        height: 529px;
        width: 1200px;
        border: 1px solid black;
        margin: 0 auto;
    }

    .bj_left_ul {
        float: left;
    }

    .bj_input {
        float: left;
        margin-top: 50px;
        margin-left: 10px;
        display: none;
    }

    .bj_input > textarea {
        resize: none;
        height: 150px;
        width: 200px;
    }

    .dashed_div1 {
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
        border: 1px dashed #222;
        margin: 0 auto;
    }

    .btn_comfirm {
        height: 40px;
        width: 120px;
        background-color: blue;
        border-radius: 5px;
        line-height: 30px;
        text-align: center;
        font-size: 16px;
        color: white;
        font-weight: bold;
    }

    .out_div {
        margin-top: 20px;
        height: 600px;
        width: 400px;
        border: 1px solid black;
    }

    .cover_div {
        position: absolute;
        left: 0;
        top: 0;
        z-index: 200;
    }

    .holder_div {
        position: relative;
        float: left;
        margin-left: 50px;
        overflow: hidden;
    }

    .bj_right_ul {
        position: relative;
        z-index: 200;
        padding: 0 0 50px 0;
        margin: 0;
        border: 1px solid lightblue;
        background-color: #eef;
    }

    .scroll_div {
        overflow-y: auto;
    }
</style>
<body>
<div class="bj_bigdiv">
    <ul class="bj_left_ul">
        <li id="input_type" draggable="true">我是输入框部件</li>
        <li id="image_type" draggable="true">我是图片部件</li>
    </ul>
    <div class="holder_div">
        <div class="cover_div"></div>
        <div class="scroll_div">
            <ul class="bj_right_ul"></ul>
        </div>
    </div>
    <div class="bj_input">
        <textarea id="input_area" value="这里可以输入文字"></textarea><br/>
        <button id="confirm">确 认</button>
    </div>
</div>
<br/>
<button class="btn_comfirm" id="conf">确认生成对象</button>
<button class="btn_comfirm" id="output">生成网页</button>
<div class="out_div">
    <ul id="out_ul">
    </ul>
</div>
</body>
<script>
    //注意：不要随便给li加padding，margin什么的。
    $(function () {
        var LEFTDIVWIDTH = 300;
        var LEFTDIVHEIGHT = 500;//定义左边的ul的宽高，以便嵌入其他元素时好改动
        var RIGHTDIVWIDTH = 300;
        var RIGHTDIVHEIGHT = 500;//定义右边的ul的宽高，以便嵌入其他元素时好改动
        var SCROLLDIVWIDTH = 330;
        var SCROLLDIVHEIGHT = 500;//定义滚动框，也就是目标ul的父级div的宽高
        var HOLDERDIVWIDTH = 400;
        var HOLDERDIVHEIGHT = 500;//定义定位层holder_div的宽高
        var RIGHTLIHEIGHT = 60;
        var RIGHTLIWIDTH = 300;//生成的li的宽高
        var DASHEDDIVHEIGHT = 200;//虚线框的高度
        var DASHEDDIVWIDTH = 300;//虚线框的宽度


        $(".bj_left_ul").css({"height": LEFTDIVHEIGHT, "width": LEFTDIVWIDTH});//左边ul宽高赋值
        $(".scroll_div").css({"height": SCROLLDIVHEIGHT, "width": SCROLLDIVWIDTH});//右边ul宽高赋值
        $(".bj_right_ul").css({"min-height": RIGHTDIVHEIGHT, "width": RIGHTDIVWIDTH});//右边ul宽高赋值
        $(".cover_div").css({"height": SCROLLDIVHEIGHT, "width": RIGHTDIVWIDTH});//右边ul的cover层的宽高赋值，高度为scroll层的高度！！
        $(".bj_right_ul>li").css({"height": RIGHTLIHEIGHT, "width": RIGHTLIWIDTH});//右边ul的cover层的宽高赋值

        // $(".holder_div").css({ "height": HOLDERDIVHEIGHT,"width": HOLDERDIVWIDTH});//右边定位层holder_div的宽高赋值
        var options = [];//维护右边ul结构的对象数组，形如 [{startY:30,endY:60,height:20},{...},{...}];
        //!!!!!options数组对象中的对象的顺序从始至终都没有改变过，因为就算目标ul中的li的顺序改变了，li的数量是绝对不会改变的。
        //不用维护options这个数组的顺序，哈哈。
        var data_type;//由于在dragover事件中拿不到dataTransfer中的数据，干脆全部用全局变量代替了。！！！
        var oldHeight;
        var oldK;
        //源对象
        $(".bj_left_ul>li").on("dragstart", function (event) {
            //firefox卖萌吧，不加这行语句就没效果。
            event.originalEvent.dataTransfer.setData("Text", "");//firefox卖萌吧，不加这行语句就没效果。
            data_type = event.target.id;
            $(".cover_div").css({"z-index": 300});//注意，这里z-index是300
            var img=
            event.originalEvent.dataTransfer.setDragImage($("<img src='chrome.png'/>")[0],0,0);
        });
        var idNum = 1;//关联li与改变li内容的框。

        //目标对象
        var _coverDiv = $(".cover_div");
        _coverDiv.on("dragover", function (event) {
            event.preventDefault();
            event.stopPropagation();
            var data = data_type;
            $("#dashed_div").parent().remove();
            if (data == "") {
                return false;
            }
            else {
                var $item = $(document.createElement("li"));
                var html = "";
                if (data == "input_type") {
                    html = "<div id='dashed_div' class='dashed_div1'></div>";
                }
                else if (data == "image_type") {
                    html = "<div id='dashed_div' class='dashed_div1'></div>";
                }
                $item.html(html);//虚线框节点赋值完毕
                //获取鼠标相对于目标ul左上角的坐标
                var x = event.originalEvent.pageX - _coverDiv.offset().left;//鼠标相对于容器的x坐标
                var y = event.originalEvent.pageY - _coverDiv.offset().top;//鼠标相对于容器的y坐标
                x += $(".scroll_div").scrollLeft();//加上滚动偏移x，否则滚动之后就完蛋了
                y += $(".scroll_div").scrollTop();//加上滚动偏移y，否则滚动之后就完蛋了

                var _destUl = $(".bj_right_ul");
                var k = options.length;//option对象数组的长度，放在外边，防止长度改变之后影响其他部分
                if (options.length == 0) {
                    _destUl.append($item);
                } else {
                    for (var i = 0; i < k; i++) {
                        if (y >= options[i].startY && y <= options[i].endY) {//放在了ul中的li上
                            if (y <= options[i].endY) {//放在上半部分
//                                console.log(options[i].startY+" "+options[i].endY+" "+y);
//                                console.log();
//
//                                if(options[i].height!=DASHEDDIVHEIGHT) {
//                                    if(oldK && options[oldK].height==DASHEDDIVHEIGHT) {
//                                        options[oldK].height = oldHeight;
//                                        options[oldK].endY = options[oldK].startY + options[oldK].height - 1;
//                                    }
//                                    oldHeight = options[i].height;
//                                    options[i].height = DASHEDDIVHEIGHT;
//                                    options[i].endY = options[i].startY + options[i].height - 1;
//                                    oldK = i;
//                                }

                                DASHEDDIVHEIGHT=options[i].height;
                                $("#dashed_div").parent().remove();
                                _destUl.find("li:nth-child(" + (i + 1) + ")").before($item);
                            }//这个if的else是放在了下半部分，然而根本不会放到下半部分
                            break;//已经添加过了LI了就break.
                        }
//                        else if(oldK && (options[i].height==DASHEDDIVHEIGHT || (i-1)&&options[i-1].height==DASHEDDIVHEIGHT || (i+1)&&options[+1].height==DASHEDDIVHEIGHT)) {
////                        else if(oldK && options[i].height==DASHEDDIVHEIGHT) {
//                            options[oldK].height = oldHeight;
//                            options[oldK].endY = options[oldK].startY + options[oldK].height - 1;
//                        }
                    }
                    if (i == k) {//i==k时，所有的li都检查过了且不满足，放在了ul中的其他地方
                        _destUl.append($item);
                    }
                }
            }
            $(".dashed_div1").css({"height": DASHEDDIVHEIGHT, "width": DASHEDDIVWIDTH});//虚线框宽高，必须在虚线框生成之后赋值
        });
        _coverDiv.on("dragleave", function (event) {
            event.preventDefault();
            event.stopPropagation();
//            options[oldK].height=oldHeight;
//            options[oldK].endY=options[oldK].startY+options[oldK].height-1;
            $("#dashed_div").parent().remove();
        });
        _coverDiv.on("drop", function (event) {
            event.preventDefault();
            event.stopPropagation();

            if(oldK) {
                options[oldK].height = oldHeight;
                options[oldK].endY = options[oldK].startY + options[oldK].height - 1;
            }

            var data = data_type;
            //生成将要保存的li节点的信息对象
            var objLi = {
                startY: 0,
                endY: 0,
                height: RIGHTLIHEIGHT
            };
            //定下新生节点的默认值
            objLi.endY = objLi.height;//默认startY是0，endY是高度。
            if (options.length > 0) {//如果维护的数组大于0，要插入的li的起始位置为上一个li的结束位置加1,否则就是0。
                objLi.startY = options[options.length - 1].endY + 1;//必须要大1
                objLi.endY = objLi.startY + objLi.height - 1;//必须要减1否则就大了1了！
            }

            idNum++;
            var $item = $(document.createElement("li"));
            $item.attr("id", "li" + idNum);
            $item.css({"text-align": "center"});
            $(".bj_input").show();
            $(".bj_input>textarea").attr("name", $item.attr("id")).val("这里输入的内容会更新到左边的框里。");//在生成li的时候要直接修改textarea的name一次。
            $item.click(function () {//必须在生成li的时候加，否则事件触发不了
                $(".bj_input>textarea").attr("name", $item.attr("id"));
            });
            $(".bj_right_ul>li").removeClass("redborder");//放下时显示红框
            $item.addClass("redborder");

            var html = "";
            if (data == "input_type") {
                html = "<input id='d1' class='bj_change_value' type='text' value='输入文本'/>";
                $item.attr("data-type", "input_type");
                $item.attr("data-height", RIGHTLIHEIGHT + "px");
            }
            else if (data == "image_type") {
                html = "<img src='chrome.png'/>";
                $item.attr("data-type", "image_type");
                $item.attr("data-height", RIGHTLIHEIGHT + "px");
            }
            $item.html(html);//新li节点赋值完毕
            //获取鼠标相对于目标ul左上角的坐标
            var x = event.originalEvent.pageX - _coverDiv.offset().left;//鼠标相对于容器的x坐标
            var y = event.originalEvent.pageY - _coverDiv.offset().top;//鼠标相对于容器的y坐标
            x += $(".scroll_div").scrollLeft();//加上滚动偏移x，否则滚动之后就完蛋了
            y += $(".scroll_div").scrollTop();//加上滚动偏移y，否则滚动之后就完蛋了

            var _destUl = $(".bj_right_ul");
            var k = options.length;//option对象数组的长度，放在外边，防止长度改变之后影响其他部分
            if (options.length == 0) {
                options.push(objLi);
                _destUl.append($item);
            } else {
                for (var i = 0; i < k; i++) {
                    if (y >= options[i].startY && y <= options[i].endY) {//放在了ul中的li上
                        if (y <= options[i].endY) {//放在上半部分
                            objLi.startY = options[i].startY;
                            objLi.endY = objLi.startY + objLi.height - 1;//只能在定了插入位置之后给当前要插入的li，赋值开始结束位置。
                            options.splice(i, 0, objLi);//在当前li前面插入。
                            _destUl.find("li:nth-child(" + (i + 1) + ")").before($item);
                            //维护对象数组得在插入之后，只需要维护基本的坐标就行了，信息没必要维护
                            for (var j = i + 1, len = options.length; j < len; j++) {//将下面的位置重置
                                options[j].startY = options[j - 1].endY + 1;
                                options[j].endY = options[j].startY + options[j].height - 1;//卧槽，陷阱啊，1+36就是37了，如果这里加37，那么每次都多1！！！！
                            }
                        }
                        break;//已经添加过了LI了就break.
                    }
                }
                if (i == options.length) {//options的长度没变化，所有的li都检查过了，放在了ul中的其他地方
                    options.push(objLi);
                    _destUl.append($item);
                }
            }
            $("#dashed_div").parent().remove();//添加了节点之后要删除虚线框
            $(".cover_div").css({"z-index": 100});//要将z-index改为100
            $(".bj_right_ul>li").css({"height": RIGHTLIHEIGHT, "width": RIGHTLIWIDTH})//右边ul的cover层的宽高赋值,必须要在插入li之后赋值
                    .on("mouseover", function () {
                        $(this).addClass("hover");
                    })
                    .on("mouseout", function () {
                        $(this).removeClass("hover");
                    });
        });
        var _dest = $(".bj_right_ul");
        _dest.sortable();//JQUERY UI sortable组件
    });
    $(function () {
        $(":not(.bj_right_ul)").on("drop", function (event) {//取消其它框（除了.bj_right_ul框）拖入东西的默认效果。
            event.preventDefault();
            event.stopPropagation();
        });
        $("#confirm").click(function () {//点击确定，将textarea中的文本放到对应的li中。
            var text = $("#input_area").val();
            if (text) {
                var liId = $("#input_area").attr("name");
                if (liId) {
                    $("#" + liId).html(text);
                    $("#" + liId).attr("data-change", "changed");
                }
            }
        });
        $(document).click(function (event) {//点击
            if (event.target.id.slice(0, 2) == "li") {
                $(".bj_input").show();
                //控制红框
                $(".bj_right_ul>li").removeClass("redborder");
                $(event.target).addClass("redborder");
            } else if (event.target.id == "input_area" || event.target.id == "confirm") {
                //这里是点击了右部编辑框的输入框或者是按钮，什么也不干。
            } else {
                $(".bj_right_ul>li").removeClass("redborder");
                $(".bj_input").hide();
            }
        });

        //生成一个用于生成网页的对象,对象的样子是[{type:"data-type",text:"",isChange:true}]
        var product = [];
        $("#conf").click(function () {
            var lis = $(".bj_right_ul>li");
            for (var i = 0; i < lis.length; i++) {
                var oneLi = {};
                oneLi.type = lis[i].getAttribute("data-type");
                if (lis[i].getAttribute("data-change") == "changed") {
                    oneLi.text = $(lis[i]).html();
                    oneLi.isChange = true;
                }
                product.push(oneLi);
            }
        });
        //生成网页
        //根据对象poduct[i]中的数据生成网页。
        $("#output").click(function () {
            var _lis = $("#out_ul");
            var htmlText = "";
            for (var i = 0; i < product.length; i++) {
                if (product[i].type == "input_type") {
                    if (product[i].isChange && product[i].isChange == true) {
                        htmlText += "<li>" + product[i].text + "</li>";
                    } else {
                        htmlText += "<li><input class='bj_change_value' type='text' value='输入文本'/></li>"
                    }
                }
                if (product[i].type == "image_type") {
                    if (product[i].isChange && product[i].isChange == true) {
                        htmlText += "<li>" + product[i].text + "</li>";
                    } else {
                        htmlText += "<li><img src='chrome.png'/></li>"
                    }
                }
            }
            _lis.html(htmlText);
            product.length = 0;
        });
    });
</script>
</html>
