<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>拖动div的特效1</title>
	<script src="jquery-1.11.3.js"></script>
	<script src="jquery-ui.js"></script>
</head>
<style>
li{
	display:block;
	list-style-type:none;
	width:270px;
	height:30px;
	border:1px solid black;
	padding-top:5px;
}
.bj_bigdiv{
	height:529px;
	width:1200px;
	border:1px solid black;
}
.bj_left_div,
.bj_right_div{
	height:500px;
	width:300px;
	margin:20px 50px;
	float:left;
	border:1px solid black;
}
.bj_input{
	float:left;
	margin-top:50px;
	margin-left:10px;
	display:none;
}
.bj_input>textarea{
	resize:none;
	height:150px;
	width:200px; 
}
.dashed_div1{
	height:30px;
	width:270px;
	border:1px dashed #222;
}
.dashed_div2{
	height:50px;
	width:270px;
	border:1px dashed green;
}.dashed_div3{
	height:0px;
	width:270px;
	border:1px dashed green;
}
.btn_comfirm{
	height:40px;
	width:120px;
	background-color:blue;
	border-radius:5px;
	line-height:30px;
	text-align:center;
	font-size:16px;
	color:white;
	font-weight: bold;
}
.out_div{
	margin-top:20px;
	height:600px;
	width:400px;
	border:1px solid black;
}
</style>
<body>
	<div class="bj_bigdiv">
		<ul class="bj_left_div">
			<li id="input_type" draggable="true">我是输入框部件</li>
			<li id="image_type" draggable="true">我是图片部件</li>
		</ul>
		<ul class="bj_right_div">

		</ul>
		<div class="bj_input">
			<textarea id="input_area" value="这里可以输入文字"></textarea><br/>
			<button id="confirm">确  认</button>
		</div>
	</div>
	<br/>
	<button class="btn_comfirm" id="conf">确认生成对象</button>
	<button class="btn_comfirm" id="output">生成网页</button>

	<div class="out_div">
		<ul id="out_ul">

		</ul>
	</div>
</body>
<script>

$(function(){
 		var idNum=1;//关联li与改变li内容的框。
 		//源对象
 		$(".bj_left_div>li").on("dragstart",function(event){
 			event.originalEvent.dataTransfer.setData("Text",event.target.id);
 		});

 		//目标对象
 		var $dest=$(".bj_right_div");
 		$dest.on("dragover", function(event) {
 			event.preventDefault();
 			event.stopPropagation();
 			$("[data-dashed='true']").parent().remove();//同时只能显示一个虚线框，显示之前要删除以前的。
 			var df=event.originalEvent.dataTransfer;
 			var data=df.getData("Text");
 			var el=event.target;//目标对象
 			var ctx=$(this)[0];//当前容器
 			if(data==""){
 				return false;
 			}
 			else{
 				var appended=false;//判断是否已经添加过了。防止在循环中反复添加
 				do{
 					var $item=$(document.createElement("li"));
 					$item.attr("id","dashedLi");
 
 					var html="";
 					if(data=="input_type"){
 						html="<div class='dashed_div1' data-dashed='true'>我是虚线框1</div>";
 					}
 					else if(data=="image_type"){
 						html="<div class='dashed_div2' data-dashed='true'>我是虚线框2</div>";
 					}
 					$item.html(html);
 					if($(this).children().length>0){//目标有子元素，现在有也只能是li元素。
 						if(el.nodeName=="LI"){
 							if(el.nextElementSibling){
 								el.parentNode.insertBefore($item.get(0),el.nextElementSibling);
 							}else{
 								ctx.appendChild($item.get(0));
 							}
 							appended=true;
 						}else if(appended==false && $(el).hasClass("bj_right_div")){//目标就是最大的容器，拖到夹缝中也是这个
 								ctx.appendChild($item.get(0));
 						}
 					}else{//目标没有li
 						ctx.appendChild($item.get(0));
 					}
 				}while(el !== ctx && (el = el.parentNode));//为了防止放到li的元素的内部。
 			}

 		});
		//鼠标离开$dest目标，就删除添加的东西
		$dest.on("dragleave", function(event) {
 			event.preventDefault();
 			event.stopPropagation();
 			$("[data-dashed='true']").parent().remove();
 			console.log("asdfasdfddddddddddddddd");
		});
 		$dest.on("drop",function(event){
 			event.preventDefault();
 			event.stopPropagation();

 			//删除添加的虚线框
 			$("[data-dashed='true']").parent().remove();

 			var df=event.originalEvent.dataTransfer;
 			var data=df.getData("Text");
 			var el=event.target;//目标对象
 			if(el.id=="dashedLi"){
 				el=$(".bj_right_div")[0];
 			}
 			var ctx=$(this)[0];//当前容器
 			if(data==""){
 				return false;
 			}
 			else{
 				idNum++;
 				var appended=false;//判断是否已经添加过了。防止在循环中反复添加
 				do{
 					var $item=$(document.createElement("li"));
 					$item.attr("id","li"+idNum);
 					$item.attr("data-type");//用于生成对象的自定义属性
 					$item.attr("data-change");//用于判断li里面的内容是否改变。
 					$(".bj_input").show();
 					$(".bj_input>textarea").attr("name",$item.attr("id")).val("这里输入的内容会更新到左边的框里。");//在生成li的时候要直接修改textarea的name一次。

 					$item.click(function(){//必须在生成li的时候加，否则事件触发不了
 						$(".bj_input>textarea").attr("name",$item.attr("id"));
 					});
 					var html="";
 					if(data=="input_type"){
 						html="<input id='d1' class='bj_change_value' type='text' value='输入文本'/>";
 						$item.attr("data-type","input_type");

 					}
 					else if(data=="image_type"){
 						html="<img src='chrome.png'/>";
 						$item.attr("data-type","image_type");
 					}
 					$item.html(html);
 					if($(this).children().length>0){//目标有子元素，现在有也只能是li元素。
 						if(el.nodeName=="LI"){
 							if(el.nextElementSibling){
 								el.parentNode.insertBefore($item.get(0),el.nextElementSibling);
 							}else{
 								ctx.appendChild($item.get(0));
 							}
 							appended=true;
 						}else if(appended==false && $(el).hasClass("bj_right_div")){//目标就是最大的容器，拖到夹缝中也是这个
 							ctx.appendChild($item.get(0));
 						}
 					}else{//目标没有li
 						ctx.appendChild($item.get(0));
 					}
 				}while(el !== ctx && (el = el.parentNode));//为了防止放到li的元素的内部。
 			}
 		});
 		$dest.sortable();//JQUERY UI sortable组件
 	});

$(function(){
 		$("#input_area").on("drop",function(event){//取消textarea框拖入东西的默认效果。
 			event.preventDefault();
 			event.stopPropagation();
 		});
 		$("#confirm").click(function(){//点击确定，将textarea中的文本放到对应的li中。
 			var text=$("#input_area").val();
 			if(text){
 				var liId=$("#input_area").attr("name");	
 				if(liId){
 					$("#"+liId).html(text);
 					$("#"+liId).attr("data-change","changed");
 				}
 			}
 		});
 		$(document).click(function(event){//点击
 			if(event.target.id.slice(0,2)=="li"){
 				$(".bj_input").show();
 			}else if(event.target.id=="input_area"||event.target.id=="confirm"){
 				//这里是点击了右部编辑框的输入框或者是按钮，什么也不干。
 			}else{
 				$(".bj_input").hide();
 			}
 		});

 		//生成一个用于生成网页的对象,对象的样子是[{type:"data-type",text:"",isChange:true}]
 		var product=[];
 		$("#conf").click(function(){
 			var lis=$(".bj_right_div>li");
 			for(var i=0;i<lis.length;i++){
 				var oneLi={};
 				oneLi.type=lis[i].getAttribute("data-type");
 				if(lis[i].getAttribute("data-change")=="changed"){
 					oneLi.text=$(lis[i]).html();
 					oneLi.isChange=true;
 				}
 				product.push(oneLi);
 			}
 		});
 		//生成网页
 		//根据对象poduct[i]中的数据生成网页。
 		$("#output").click(function(){
 			var _lis=$("#out_ul");
 			var htmlText="";
 			for(var i=0;i<product.length;i++){
 				if(product[i].type=="input_type"){
 					if(product[i].isChange && product[i].isChange==true){
 						htmlText+="<li>"+product[i].text+"</li>";
 					}else{
 						htmlText+="<li><input class='bj_change_value' type='text' value='输入文本'/></li>"
 					}
 				}
 				if(product[i].type=="image_type"){
 					if(product[i].isChange && product[i].isChange==true){
 						htmlText+="<li>"+product[i].text+"</li>";
 					}else{
 						htmlText+="<li><img src='chrome.png'/></li>"
 					}
 				}
 			}
 			_lis.html(htmlText);
 			product.length=0;
 		});
 	});

</script>
</html>
